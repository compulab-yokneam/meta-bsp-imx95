From 269ecfaaccff508c73234c2328c5f49c7d57906a Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Mon, 16 Sep 2024 17:18:15 +0300
Subject: [PATCH] compulab: Update ucm-imx95 board files

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 arch/arm/dts/ucm-imx95-u-boot.dtsi   |  28 ------
 arch/arm/dts/ucm-imx95.dts           | 131 +--------------------------
 board/compulab/ucm-imx95/ucm-imx95.c |   6 +-
 3 files changed, 5 insertions(+), 160 deletions(-)

diff --git a/arch/arm/dts/ucm-imx95-u-boot.dtsi b/arch/arm/dts/ucm-imx95-u-boot.dtsi
index dec6e64abee..4f25fef6ecb 100644
--- a/arch/arm/dts/ucm-imx95-u-boot.dtsi
+++ b/arch/arm/dts/ucm-imx95-u-boot.dtsi
@@ -215,34 +215,6 @@
 	bootph-pre-ram;
 };
 
-&i2c3_gpio_expander_20 {
-	compatible = "ti,tca6408";
-	label = "i2c3_io";
-};
-
-&i2c4_gpio_expander_21 {
-	compatible = "ti,tca6408";
-	label = "i2c4_io";
-};
-
-&i2c5_gpio_expander_21 {
-	compatible = "ti,tca6408";
-	label = "i2c5_io";
-};
-
-&i2c6_gpio_expander_21 {
-	compatible = "ti,tca6416";
-	label = "i2c6_io";
-};
-
-&flexspi1 {
-	bootph-pre-ram;
-};
-
-&mt35xu01gbba {
-	bootph-pre-ram;
-};
-
 &pinctrl_flexspi1 {
 	bootph-pre-ram;
 };
diff --git a/arch/arm/dts/ucm-imx95.dts b/arch/arm/dts/ucm-imx95.dts
index 661c28cf209..289d6199454 100644
--- a/arch/arm/dts/ucm-imx95.dts
+++ b/arch/arm/dts/ucm-imx95.dts
@@ -30,6 +30,7 @@
 		regulator-min-microvolt = <3300000>;
 		regulator-name = "+V3.3_SW";
 	};
+
 	reg_usdhc2_vmmc: regulator-usdhc2 {
 		compatible = "regulator-fixed";
 		pinctrl-names = "default";
@@ -42,34 +43,8 @@
 		enable-active-high;
 	};
 
-	reg_usb_vbus: regulator-vbus {
-		compatible = "regulator-fixed";
-		regulator-name = "USB_VBUS";
-		regulator-min-microvolt = <5000000>;
-		regulator-max-microvolt = <5000000>;
-		gpio = <&i2c7_pcal6524 3 GPIO_ACTIVE_HIGH>;
-		enable-active-high;
-		regulator-always-on;
-	};
-};
-
-&flexspi1 {
-	pinctrl-names = "default";
-	pinctrl-0 = <&pinctrl_flexspi1>;
-	status = "okay";
-
-	mt35xu01gbba: flash@0 {
-		reg = <0>;
-		#address-cells = <1>;
-		#size-cells = <1>;
-		compatible = "jedec,spi-nor";
-		spi-max-frequency = <200000000>;
-		spi-tx-bus-width = <8>;
-		spi-rx-bus-width = <8>;
-	};
 };
 
-
 &lpi2c2 {
 	#address-cells = <1>;
 	#size-cells = <0>;
@@ -95,14 +70,6 @@
 	pinctrl-0 = <&pinctrl_lpi2c3>;
 	pinctrl-1 = <&pinctrl_lpi2c3>;
 	status = "okay";
-
-	i2c3_gpio_expander_20: i2c3-gpio-expander@20 {
-		compatible = "nxp,pcal6408";
-		#gpio-cells = <2>;
-		gpio-controller;
-		reg = <0x20>;
-		vcc-supply = <&reg_3p3v>;
-	};
 };
 
 &lpi2c4 {
@@ -113,20 +80,6 @@
 	pinctrl-0 = <&pinctrl_lpi2c4>;
 	pinctrl-1 = <&pinctrl_lpi2c4>;
 	status = "okay";
-
-	i2c4_gpio_expander_21: i2c4-gpio-expander@21 {
-		compatible = "nxp,pcal6408";
-		#gpio-cells = <2>;
-		gpio-controller;
-		reg = <0x21>;
-		interrupt-controller;
-		#interrupt-cells = <2>;
-		interrupt-parent = <&gpio2>;
-		interrupts = <18 IRQ_TYPE_LEVEL_LOW>;
-		pinctrl-names = "default";
-		pinctrl-0 = <&pinctrl_i2c4_pcal6408>;
-		vcc-supply = <&reg_3p3v>;
-	};
 };
 
 &lpi2c5 {
@@ -137,16 +90,6 @@
 	pinctrl-0 = <&pinctrl_lpi2c5>;
 	pinctrl-1 = <&pinctrl_lpi2c5>;
 	status = "okay";
-
-	i2c5_gpio_expander_21: i2c5-gpio-expander@21 {
-		compatible = "nxp,pcal6408";
-		#gpio-cells = <2>;
-		gpio-controller;
-		reg = <0x21>;
-		vcc-supply = <&reg_3p3v>;
-	};
-
-	/* ENET PMIC MPF5103 addr 0x8 */
 };
 
 &lpi2c6 {
@@ -157,20 +100,6 @@
 	pinctrl-0 = <&pinctrl_lpi2c6>;
 	pinctrl-1 = <&pinctrl_lpi2c6>;
 	status = "okay";
-
-	i2c6_gpio_expander_21: i2c6-gpio-expander@21 {
-		compatible = "nxp,pcal6416";
-		#gpio-cells = <2>;
-		gpio-controller;
-		reg = <0x21>;
-		interrupt-controller;
-		#interrupt-cells = <2>;
-		interrupt-parent = <&gpio4>;
-		interrupts = <28 IRQ_TYPE_LEVEL_LOW>;
-		pinctrl-names = "default";
-		pinctrl-0 = <&pinctrl_pcal6416>;
-		vcc-supply = <&reg_3p3v>;
-	};
 };
 
 &lpi2c7 {
@@ -181,54 +110,10 @@
 	pinctrl-0 = <&pinctrl_lpi2c7>;
 	pinctrl-1 = <&pinctrl_lpi2c7>;
 	status = "okay";
-
-	i2c7_pcal6524: i2c7-gpio@22 {
-		compatible = "nxp,pcal6524";
-		pinctrl-names = "default";
-		pinctrl-0 = <&pinctrl_i2c7_pcal6524>;
-		reg = <0x22>;
-		gpio-controller;
-		#gpio-cells = <2>;
-		interrupt-controller;
-		#interrupt-cells = <2>;
-		interrupt-parent = <&gpio5>;
-		interrupts = <16 IRQ_TYPE_LEVEL_LOW>;
-	};
-
-	ptn5110: tcpc@50 {
-		compatible = "nxp,ptn5110";
-		reg = <0x50>;
-		interrupt-parent = <&gpio5>;
-		interrupts = <14 IRQ_TYPE_LEVEL_LOW>;
-		pinctrl-names = "default";
-		pinctrl-0 = <&pinctrl_ptn5110>;
-
-		port {
-			typec_dr_sw: endpoint {
-				remote-endpoint = <&usb3_drd_sw>;
-			};
-		};
-
-		typec1_con: connector {
-			compatible = "usb-c-connector";
-			label = "USB-C";
-			power-role = "dual";
-			data-role = "dual";
-			try-power-role = "sink";
-			source-pdos = <PDO_FIXED(5000, 3000, PDO_FIXED_USB_COMM)>;
-			sink-pdos = <PDO_FIXED(5000, 3000, PDO_FIXED_USB_COMM)
-				     PDO_VAR(5000, 20000, 3000)>;
-			op-sink-microwatt = <15000000>;
-			self-powered;
-		};
-	};
-
-	/* SI5332 */
 };
 
 &usb2 {
 	dr_mode = "host";
-	vbus-supply = <&reg_usb_vbus>;
 	hnp-disable;
 	srp-disable;
 	adp-disable;
@@ -245,21 +130,11 @@
 };
 
 &usb3_dwc3 {
-	dr_mode = "otg";
+	dr_mode = "peripheral";
 	hnp-disable;
 	srp-disable;
 	adp-disable;
-	usb-role-switch;
-	role-switch-default-mode = "none";
-	snps,dis-u1-entry-quirk;
-	snps,dis-u2-entry-quirk;
 	status = "okay";
-
-	port {
-		usb3_drd_sw: endpoint {
-			remote-endpoint = <&typec_dr_sw>;
-		};
-	};
 };
 
 &lpuart1 {
@@ -310,9 +185,11 @@
 	ethphy0: ethernet-phy@1 {
 		reg = <1>;
 		eee-broken-1000t;
+#if 0
 		reset-gpios = <&i2c5_gpio_expander_21 2 GPIO_ACTIVE_LOW>;
 		reset-assert-us = <10000>;
 		reset-deassert-us = <80000>;
+#endif
 	};
 
 	ethphy2: ethernet-phy@8 {
diff --git a/board/compulab/ucm-imx95/ucm-imx95.c b/board/compulab/ucm-imx95/ucm-imx95.c
index 40defe2c6b9..08cb552f347 100644
--- a/board/compulab/ucm-imx95/ucm-imx95.c
+++ b/board/compulab/ucm-imx95/ucm-imx95.c
@@ -71,11 +71,7 @@ int board_early_init_f(void)
 #define PHY_CTRL6_ALT_CLK_SEL		BIT(0)
 
 static struct dwc3_device dwc3_device_data = {
-#ifdef CONFIG_SPL_BUILD
 	.maximum_speed = USB_SPEED_HIGH,
-#else
-	.maximum_speed = USB_SPEED_SUPER,
-#endif
 	.base = USB1_BASE_ADDR,
 	.dr_mode = USB_DR_MODE_PERIPHERAL,
 	.index = 0,
@@ -238,7 +234,7 @@ int board_init(void)
 
 	netc_init();
 
-	power_on_m7("mx95alt");
+	power_on_m7("mx95cust");
 
 	return 0;
 }
